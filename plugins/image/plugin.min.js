tinymce.PluginManager.add("image",function(e){function c(h,j){var g=document.createElement("img");function f(l,k){if(g.parentNode){g.parentNode.removeChild(g)}j({width:l,height:k})}g.onload=function(){f(Math.max(g.width,g.clientWidth),Math.max(g.height,g.clientHeight))};g.onerror=function(){f()};var i=g.style;i.visibility="hidden";i.position="fixed";i.bottom=i.left=0;i.width=i.height="auto";document.body.appendChild(g);g.src=h}function d(h,f,i){function g(k,j){j=j||[];tinymce.each(k,function(m){var l={text:m.text||m.title};if(m.menu){l.menu=g(m.menu)}else{l.value=m.value;f(l)}j.push(l)});return j}return g(h,i||[])}function b(f){return function(){var g=e.settings.image_list;if(typeof g=="string"){tinymce.util.XHR.send({url:g,success:function(h){f(tinymce.util.JSON.parse(h))}})}else{if(typeof g=="function"){g(f)}else{f(g)}}}}function a(p){var j,y={},s=e.dom,g,q;var o,m,t,i,k=e.settings.image_dimensions!==false;function f(){var A,C,B,z;A=j.find("#width")[0];C=j.find("#height")[0];if(!A||!C){return}B=A.value();z=C.value();if(j.find("#constrain")[0].checked()&&o&&m&&B&&z){if(o!=B){z=Math.round((B/o)*z);if(!isNaN(z)){C.value(z)}}else{B=Math.round((z/m)*B);if(!isNaN(B)){A.value(B)}}}o=B;m=z}function l(){var A,B;function z(D){function C(){D.onload=D.onerror=null;if(e.selection){e.selection.select(D);e.nodeChanged()}}D.onload=function(){if(!y.width&&!y.height&&k){s.setAttribs(D,{width:D.clientWidth,height:D.clientHeight})}C()};D.onerror=C}n();f();y=tinymce.extend(y,j.toJSON());if(!y.alt){y.alt=""}if(!y.title){y.title=""}if(y.width===""){y.width=null}if(y.height===""){y.height=null}if(!y.style){y.style=null}y={src:y.src,alt:y.alt,title:y.title,width:y.width,height:y.height,style:y.style,caption:y.caption,"class":y["class"]};e.undoManager.transact(function(){if(!y.src){if(g){s.remove(g);e.focus();e.nodeChanged()}return}if(y.title===""){y.title=null}if(!g){y.id="__mcenew";e.focus();e.selection.setContent(s.createHTML("img",y));g=s.get("__mcenew");s.setAttrib(g,"id",null)}else{s.setAttribs(g,y)}e.editorUpload.uploadImagesAuto();if(y.caption===false){if(s.is(g.parentNode,"figure.image")){A=g.parentNode;s.insertAfter(g,A);s.remove(A)}}function D(E){return e.schema.getTextBlockElements()[E.nodeName]}if(y.caption===true){if(!s.is(g.parentNode,"figure.image")){B=g;g=g.cloneNode(true);A=s.create("figure",{"class":"image"});A.appendChild(g);A.appendChild(s.create("figcaption",{contentEditable:true},"Caption"));A.contentEditable=false;var C=s.getParent(B,D);if(C){s.split(C,B,A)}else{s.replace(A,B)}e.selection.select(A)}return}z(g)})}function w(z){if(z){z=z.replace(/px$/,"")}return z}function r(C){var D,A,z,B=C.meta||{};if(t){t.value(e.convertURL(this.value(),"src"))}tinymce.each(B,function(F,E){j.find("#"+E).value(F)});if(!B.width&&!B.height){D=e.convertURL(this.value(),"src");A=e.settings.image_prepend_url;z=new RegExp("^(?:[a-z]+:)?//","i");if(A&&!z.test(D)&&D.substring(0,A.length)!==A){D=A+D}this.value(D);c(e.documentBaseURI.toAbsolute(this.value()),function(E){if(E.width&&E.height&&k){o=E.width;m=E.height;j.find("#width").value(o);j.find("#height").value(m)}})}}function x(z){z.meta=j.toJSON()}g=e.selection.getNode();q=s.getParent(g,"figure.image");if(q){g=s.select("img",q)[0]}if(g&&(g.nodeName!="IMG"||g.getAttribute("data-mce-object")||g.getAttribute("data-mce-placeholder"))){g=null}if(g){o=s.getAttrib(g,"width");m=s.getAttrib(g,"height");y={src:s.getAttrib(g,"src"),alt:s.getAttrib(g,"alt"),title:s.getAttrib(g,"title"),"class":s.getAttrib(g,"class"),width:o,height:m,caption:!!q}}if(p){t={type:"listbox",label:"Image list",values:d(p,function(z){z.value=e.convertURL(z.value||z.url,"src")},[{text:"None",value:""}]),value:y.src&&e.convertURL(y.src,"src"),onselect:function(z){var A=j.find("#alt");if(!A.value()||(z.lastControl&&A.value()==z.lastControl.text())){A.value(z.control.text())}j.find("#src").value(z.control.value()).fire("change")},onPostRender:function(){t=this}}}if(e.settings.image_class_list){i={name:"class",type:"listbox",label:"Class",values:d(e.settings.image_class_list,function(z){if(z.value){z.textStyle=function(){return e.formatter.getCssText({inline:"img",classes:[z.value]})}}})}}var v=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true,onchange:r,onbeforecall:x},t];if(e.settings.image_description!==false){v.push({name:"alt",type:"textbox",label:"Image description"})}if(e.settings.image_title){v.push({name:"title",type:"textbox",label:"Image Title"})}if(k){v.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}v.push(i);if(e.settings.image_caption&&tinymce.Env.ceFalse){v.push({name:"caption",type:"checkbox",label:"Caption"})}function u(A){if(A.margin){var z=A.margin.split(" ");switch(z.length){case 1:A["margin-top"]=A["margin-top"]||z[0];A["margin-right"]=A["margin-right"]||z[0];A["margin-bottom"]=A["margin-bottom"]||z[0];A["margin-left"]=A["margin-left"]||z[0];break;case 2:A["margin-top"]=A["margin-top"]||z[0];A["margin-right"]=A["margin-right"]||z[1];A["margin-bottom"]=A["margin-bottom"]||z[0];A["margin-left"]=A["margin-left"]||z[1];break;case 3:A["margin-top"]=A["margin-top"]||z[0];A["margin-right"]=A["margin-right"]||z[1];A["margin-bottom"]=A["margin-bottom"]||z[2];A["margin-left"]=A["margin-left"]||z[1];break;case 4:A["margin-top"]=A["margin-top"]||z[0];A["margin-right"]=A["margin-right"]||z[1];A["margin-bottom"]=A["margin-bottom"]||z[2];A["margin-left"]=A["margin-left"]||z[3]}delete A.margin}return A}function n(){function B(C){if(C.length>0&&/^[0-9]+$/.test(C)){C+="px"}return C}if(!e.settings.image_advtab){return}var A=j.toJSON(),z=s.parseStyle(A.style);z=u(z);if(A.vspace){z["margin-top"]=z["margin-bottom"]=B(A.vspace)}if(A.hspace){z["margin-left"]=z["margin-right"]=B(A.hspace)}if(A.border){z["border-width"]=B(A.border)}j.find("#style").value(s.serializeStyle(s.parseStyle(s.serializeStyle(z))))}function h(){if(!e.settings.image_advtab){return}var A=j.toJSON(),z=s.parseStyle(A.style);j.find("#vspace").value("");j.find("#hspace").value("");z=u(z);if((z["margin-top"]&&z["margin-bottom"])||(z["margin-right"]&&z["margin-left"])){if(z["margin-top"]===z["margin-bottom"]){j.find("#vspace").value(w(z["margin-top"]))}else{j.find("#vspace").value("")}if(z["margin-right"]===z["margin-left"]){j.find("#hspace").value(w(z["margin-right"]))}else{j.find("#hspace").value("")}}if(z["border-width"]){j.find("#border").value(w(z["border-width"]))}j.find("#style").value(s.serializeStyle(s.parseStyle(s.serializeStyle(z))))}if(e.settings.image_advtab){if(g){if(g.style.marginLeft&&g.style.marginRight&&g.style.marginLeft===g.style.marginRight){y.hspace=w(g.style.marginLeft)}if(g.style.marginTop&&g.style.marginBottom&&g.style.marginTop===g.style.marginBottom){y.vspace=w(g.style.marginTop)}if(g.style.borderWidth){y.border=w(g.style.borderWidth)}y.style=e.dom.serializeStyle(e.dom.parseStyle(e.dom.getAttrib(g,"style")))}j=e.windowManager.open({title:"Insert/edit image",data:y,bodyType:"tabpanel",body:[{title:"General",type:"form",items:v},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:h},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:n},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:l})}else{j=e.windowManager.open({title:"Insert/edit image",data:y,body:v,onSubmit:l})}}e.on("preInit",function(){function g(i){var h=i.attr("class");return h&&/\bimage\b/.test(h)}function f(h){return function(k){var l=k.length,m;function j(i){i.attr("contenteditable",h?"true":null)}while(l--){m=k[l];if(g(m)){m.attr("contenteditable",h?"false":null);tinymce.each(m.getAll("figcaption"),j)}}}}e.parser.addNodeFilter("figure",f(true));e.serializer.addNodeFilter("figure",f(false))});e.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:b(a),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"});e.addMenuItem("image",{icon:"image",text:"Image",onclick:b(a),context:"insert",prependToContext:true});e.addCommand("mceImage",b(a))});